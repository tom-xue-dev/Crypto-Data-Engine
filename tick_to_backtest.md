# Crypto量化交易：从Tick数据到回测的完整流水线

> 目标：容量 < 100万 USD，追求高夏普、可控回撤
> 数据源：逐笔成交数据（timestamp, price, quantity, side）

---

## 一、数据处理流水线

### 1.1 原始Tick数据规范

每条记录包含：

| 字段 | 类型 | 说明 |
|------|------|------|
| timestamp | int64 | 交易所返回的毫秒级时间戳 |
| price | float64 | 成交价格 |
| quantity | float64 | 成交数量 |
| side | int8 | +1 = taker buy（主动买入），-1 = taker sell（主动卖出） |

数据来源建议：Binance、OKX、Bybit 的 WebSocket aggTrade 流或历史数据API。存储格式推荐 Parquet（列式压缩，读取快）。

### 1.2 数据清洗

```
步骤1：去重 → 按 (timestamp, price, quantity, side) 去重
步骤2：时间排序 → 严格按 timestamp 升序
步骤3：异常过滤 → 
  - 删除 quantity <= 0 或 price <= 0 的记录
  - 删除单笔价格跳变 > 5% 的记录（闪崩/数据错误）
  - 标记交易所维护时段（成交间隔 > 60s 的gap），后续回测跳过这些时段
步骤4：时区统一 → 全部转为 UTC 毫秒时间戳
```

### 1.3 Bar构造：Dollar Bar（推荐）

**为什么不用等时间K线？**

等时间K线（如1分钟线）在不同时段包含的信息量差异巨大——凌晨一根bar可能只有几笔成交，而行情剧烈时一根bar里塞了上千笔。Dollar Bar按等金额切割，每根bar包含近似相等的信息量，统计性质更稳定。

**参数选择：**

| 币种日均成交额 | 建议 Dollar Bar 大小 | 预期日均bar数 |
|---------------|---------------------|--------------|
| > 10亿 USD（BTC/ETH） | 500,000 USD | 约2000-4000根 |
| 1-10亿 USD（SOL/DOGE等） | 100,000 USD | 约2000-5000根 |
| 0.1-1亿 USD（中小币） | 20,000 USD | 约2000-5000根 |

**目标是每天产生约2000-5000根bar**，既有足够的颗粒度，又不至于噪声太大。

**每根Dollar Bar记录：**

```
bar_open_time     : 第一笔成交时间
bar_close_time    : 最后一笔成交时间
open              : 第一笔成交价
high              : 最高成交价
low               : 最低成交价
close             : 最后一笔成交价
volume            : 总成交量
dollar_volume     : 总成交金额（≈ bar_size）
num_trades        : 成交笔数
buy_volume        : 主动买入量
sell_volume       : 主动卖出量
buy_dollar        : 主动买入金额
sell_dollar       : 主动卖出金额
vwap              : 成交量加权均价
```

---

## 二、因子构造（具体参数）

以下所有因子均在Dollar Bar序列上计算。窗口长度以bar数为单位。

### 2.1 Order Flow Imbalance（OFI）

```
OFI(n) = (Σ buy_dollar[t-n:t] - Σ sell_dollar[t-n:t]) / (Σ buy_dollar[t-n:t] + Σ sell_dollar[t-n:t])
```

**推荐多尺度窗口：**

| 因子名 | 窗口n | 捕捉含义 |
|--------|-------|---------|
| OFI_fast | 20 bars | 即时资金流方向，高频信号 |
| OFI_mid | 100 bars | 短期趋势性资金流 |
| OFI_slow | 500 bars | 中期资金流趋势 |

**信号逻辑：** OFI > 0 表示买压主导，OFI < 0 表示卖压主导。多尺度OFI同向共振时信号最强。

### 2.2 大单流因子（Smart Flow）

**大单定义阈值：**

```
big_trade_threshold = rolling_mean(trade_dollar_amount, 2000 bars) × 5
```

即单笔成交金额超过近2000笔平均金额5倍的定义为大单。该阈值滚动更新，自适应不同币种和不同市场状态。

```
SmartFlow(n) = (Σ big_buy_dollar[t-n:t] - Σ big_sell_dollar[t-n:t]) / Σ big_trade_dollar[t-n:t]
```

**推荐窗口：** n = 50, 200

### 2.3 成交加速度因子（Trade Intensity）

```
λ(n) = num_trades[t-n:t] / Σ time_span[t-n:t]  （单位时间成交笔数）
λ_zscore = (λ(n) - rolling_mean(λ, 500)) / rolling_std(λ, 500)
```

**推荐窗口：** n = 20（短期脉冲检测）

**用法：** λ_zscore > 2.0 时标记为"放量事件"，结合OFI方向判断是趋势启动还是多空博弈。

### 2.4 VPIN（波动率预测因子）

在Dollar Bar上天然适配（每根bar金额近似相等）：

```
VPIN(n) = mean(|buy_volume - sell_volume| / volume, 过去n根bar)
```

**推荐窗口：** n = 50

**用法：** VPIN上升 → 信息不对称加剧 → 预期波动率升高。不直接给方向，但用于动态调整仓位大小和止损宽度。

### 2.5 价格冲击因子（Kyle Lambda）

```
Kyle_Lambda(n) = Σ|close[i] - close[i-1]| / Σ dollar_volume[i]    (过去n根bar)
```

**推荐窗口：** n = 100

**用法：** Lambda上升 = 流动性变差 = 降仓位、加宽止损；Lambda下降 = 流动性改善 = 可以加仓。

### 2.6 均值回归因子（MR Signal）

```
MR(fast, slow) = (VWAP_rolling(fast) - VWAP_rolling(slow)) / realized_vol(slow)
```

**推荐参数：** fast = 20 bars, slow = 200 bars

**含义：** MR > 0 表示短期价格高于中期均值，MR < 0 表示低于。极端值（|MR| > 2）预示回归概率上升。

### 2.7 Sweep Detection（扫单信号）

回到原始Tick数据层面检测：

```
在100ms时间窗口内：
  - 同方向连续成交 >= 5笔
  - 累计金额 > big_trade_threshold × 2
  - 价格单向滑动 > 0.05%
→ 标记为 Sweep Event，方向 = 成交方向
```

Sweep事件聚合到Dollar Bar上：每根bar内的净Sweep方向和次数。

---

## 三、信号合成与买卖决策

### 3.1 策略一：Order Flow动量策略（核心策略）

**信号合成：**

```
composite_score = w1 × OFI_fast_zscore 
                + w2 × OFI_mid_zscore 
                + w3 × SmartFlow_zscore 
                + w4 × Sweep_net_direction

初始权重：w1=0.3, w2=0.25, w3=0.3, w4=0.15
（后续用rolling OLS或岭回归在walk-forward中自适应调整）
```

所有因子在输入前做z-score标准化（窗口500 bars的滚动均值和标准差）。

**开仓条件（做多）：**

```
条件1：composite_score > +1.5（信号强度过阈值）
条件2：λ_zscore > 0.5（成交量活跃，不是死水行情）
条件3：VPIN < 0.7（信息不对称不是极端高，避免在黑天鹅前进场）
条件4：过去10根bar没有反向Sweep（避免在对手方扫单后追涨）
```

**做空条件：** 对称，composite_score < -1.5，其余条件同理。

**平仓条件：**

```
止盈：
  - composite_score回到 ±0.5 以内（信号衰减）
  - 或浮盈达到 0.3%（固定止盈，lock profit）

止损：
  - 浮亏达到 0.15%（硬止损，不可突破）
  - 或反向Sweep事件触发（流动性冲击止损）
  - 或持仓超过200根bar（时间止损，信号已过期）

移动止损（trailing stop）：
  - 浮盈超过 0.1% 后，止损上移到成本价（保本止损）
  - 浮盈超过 0.2% 后，止损上移到 +0.1%（锁定部分利润）
```

**预期持仓时间：** 20-100根Dollar Bar（根据bar频率，约几分钟到几小时）

### 3.2 策略二：均值回归策略

**开仓条件（做多）：**

```
条件1：MR < -2.0（价格显著低于均值）
条件2：OFI_fast > 0（短期资金流转为买入，确认底部反转信号）
条件3：Kyle_Lambda < 近500bar中位数（流动性尚可，能顺利出场）
```

**做空条件：** 对称，MR > +2.0 且 OFI_fast < 0。

**平仓条件：**

```
止盈：MR 回到 ±0.5 以内（回归到均值附近）
止损：浮亏 0.2%（硬止损）或 MR 继续恶化到 ±3.5（趋势化确认，认输出场）
时间止损：持仓超过500根bar
```

### 3.3 策略三：Funding Rate套利（底仓策略）

这个策略不依赖tick数据因子，但需要纳入组合。

```
条件：
  - 永续合约 funding rate > 0.01%（年化约10%+）
  - 操作：现货买入 + 等额永续合约做空
  - 持有直到 funding rate < 0.005% 或出现反向机会

风控：
  - 现货和合约仓位严格1:1
  - 合约保证金充足，维持保证金率 > 200%
  - basis剧烈波动时（>2%偏离）暂停新开仓
```

---

## 四、仓位管理系统

### 4.1 单笔仓位计算

**基于波动率的动态仓位（核心公式）：**

```
position_size = (account_equity × risk_per_trade) / (entry_price × stop_distance)

其中：
  risk_per_trade = 0.5% of equity（每笔交易最大亏损占总权益的0.5%）
  stop_distance = max(固定止损比例, ATR_multiplier × realized_vol)
```

**具体参数：**

| 参数 | 值 | 说明 |
|------|-----|------|
| risk_per_trade | 0.5% | 单笔最大风险敞口 |
| ATR_multiplier | 1.5 | 波动率倍数，用于动态止损 |
| max_position_pct | 10% | 单个币种最大仓位占总权益比例 |
| max_total_exposure | 60% | 所有方向性策略的总敞口上限 |

**示例（100万USD账户）：**

```
假设 BTC 当前价格 50,000 USD，realized_vol（200 bar） = 0.15%
stop_distance = max(0.15%, 1.5 × 0.15%) = 0.225%

position_size = (1,000,000 × 0.5%) / (50,000 × 0.225%)
             = 5,000 / 112.5
             = 44.4 BTC
             = 约 2,222,000 USD → 触发 max_position_pct 限制
             
实际仓位 = min(2,222,000, 1,000,000 × 10%) = 100,000 USD = 2 BTC
```

### 4.2 信号强度动态调仓

不是所有信号都给满仓，根据composite_score强度分档：

```
|composite_score| 在 [1.5, 2.0)  → base_size × 0.5 （弱信号，半仓）
|composite_score| 在 [2.0, 2.5)  → base_size × 0.75（中等信号）
|composite_score| 在 [2.5, 3.0)  → base_size × 1.0 （强信号，满仓）
|composite_score| >= 3.0         → base_size × 1.0 （极强信号，也只给满仓，不加杠杆追）
```

### 4.3 波动率自适应缩放（Volatility Scaling）

```
vol_scale = target_vol / realized_vol(200 bars)

target_vol = 15% 年化（日化约0.94%）
实际仓位 = base_size × min(vol_scale, 2.0)  （上限2倍，防止低波动时过度加仓）
```

低波动时自动放大仓位，高波动时自动缩小。

### 4.4 组合层面风控

```
规则1：同一时刻最多持有 3 个币种的方向性仓位
规则2：总净敞口（多-空）不超过总权益的 30%
规则3：总毛敞口（|多|+|空|）不超过总权益的 60%（Funding套利仓位不计入）
规则4：单策略当日亏损达 1% equity → 该策略当日停止交易
规则5：组合当日亏损达 2% equity → 全部策略停止，只保留Funding套利仓位
规则6：组合月度最大回撤达 5% → 全部仓位减半，进入"修复模式"持续到回撤恢复至3%以内
```

---

## 五、回测框架设计

### 5.1 回测引擎架构

```
输入层：
  Raw Tick Data → 清洗 → Dollar Bar构造 → 因子计算

信号层：
  因子序列 → z-score标准化 → 信号合成 → 开仓/平仓判断

执行层（关键！成交模拟）：
  判断订单类型：
    - Taker单：用当前bar的close成交，加滑点
    - Maker单：以概率模型决定是否成交（保守估计）

记账层：
  成交记录 → 持仓更新 → PnL计算 → 费用扣除
```

### 5.2 成交假设与滑点模型

**Taker成交模型（推荐，更保守）：**

```
实际成交价 = bar_close × (1 + side × slippage)

slippage = base_slippage + size_impact

base_slippage = 0.01%（基础滑点，覆盖微观价格波动）
size_impact = order_size / (bar_dollar_volume × liquidity_factor)
liquidity_factor = 0.1（假设你的单只能吃到bar成交量的10%而不显著冲击价格）

如果 order_size > bar_dollar_volume × 0.1 → 拆单到多个bar执行
```

**手续费：**

| 交易所 | Maker费率 | Taker费率 | 建议回测用 |
|--------|----------|----------|-----------|
| Binance VIP0 | 0.02% | 0.04% | 0.04%（按taker算） |
| OKX VIP0 | 0.02% | 0.05% | 0.05% |
| 保守估计 | - | - | 0.05%（单边） |

**每笔交易总成本 = 开仓滑点 + 开仓手续费 + 平仓滑点 + 平仓手续费**

```
假设：滑点0.01% × 2 + 手续费0.05% × 2 = 0.12% per round trip
→ 策略的平均盈利必须 > 0.12% 才有正期望
```

### 5.3 Walk-Forward 验证框架

**绝对不能用简单的train/test split。** 用Walk-Forward：

```
总数据：2年（假设2024.01 - 2025.12）

Walk-Forward参数：
  训练窗口（in-sample）：6个月
  测试窗口（out-of-sample）：1个月
  步进：1个月

第1轮：训练 2024.01-2024.06 → 测试 2024.07
第2轮：训练 2024.02-2024.07 → 测试 2024.08
第3轮：训练 2024.03-2024.08 → 测试 2024.09
...
第18轮：训练 2025.05-2025.10 → 测试 2025.11

最终业绩 = 拼接所有out-of-sample结果
```

### 5.4 关键回测指标

**必须看的核心指标：**

| 指标 | 合格线 | 优秀线 | 计算方式 |
|------|--------|--------|---------|
| 年化收益率 | > 20% | > 50% | (最终净值/初始净值)^(365/天数) - 1 |
| 最大回撤 | < 15% | < 8% | max(peak - trough) / peak |
| 夏普比率 | > 2.0 | > 3.0 | mean(daily_return) / std(daily_return) × √365 |
| Calmar比率 | > 2.0 | > 5.0 | 年化收益 / 最大回撤 |
| 胜率 | > 48% | > 55% | 盈利交易数 / 总交易数 |
| 盈亏比 | > 1.5 | > 2.0 | avg(盈利交易金额) / avg(亏损交易金额) |
| 日均交易次数 | 5-50次 | - | 太少说明样本不够，太多说明可能过拟合 |
| 单笔最大亏损 | < 0.5% equity | < 0.3% | 验证止损是否生效 |

**必须做的压力测试：**

```
1. 手续费敏感性：把手续费从0.05%上调到0.08%，策略是否仍然盈利？
2. 滑点敏感性：把滑点从0.01%上调到0.03%，策略是否仍然盈利？
3. 延迟敏感性：把信号延迟1-5根bar，收益衰减多少？
4. 极端行情回测：单独看2024年3月BTC暴跌、2024年11月大选行情等极端时段表现
5. 参数扰动：所有窗口参数±20%，收益是否稳定？（如果参数扰动一点就崩，说明过拟合）
```

---

## 六、过拟合防控清单

```
☐ 每个因子有明确的经济学解释（信息不对称、流动性、动量/反转）
☐ 因子总数 < 10（参数越少越好）
☐ 不使用未来数据（所有因子只用 t 时刻之前的数据）
☐ Walk-Forward OOS收益 > IS收益的50%（衰减过大说明过拟合）
☐ 不同币种上测试：在BTC上开发的策略，在ETH/SOL上是否也有效？
☐ 不同时间段测试：牛市、熊市、震荡市分别表现如何？
☐ 参数±20%扰动后收益变化 < 30%
☐ 夏普比率 < 4.0（超过4大概率过拟合，除非是纯套利策略）
☐ 样本量：OOS交易次数 > 500笔
```

---

## 七、实盘部署建议

### 7.1 渐进上线流程

```
阶段1（1-2周）：Paper Trading
  - 实时接收tick数据，计算信号，模拟下单但不实际执行
  - 对比模拟成交价和实际市场价，校准滑点模型

阶段2（2-4周）：小资金实盘（总资金的5-10%）
  - 实际下单，验证执行系统稳定性
  - 对比实盘PnL和回测预期，偏差 > 30%需排查

阶段3（持续）：逐步扩容
  - 每2周评估一次，如果实盘夏普 > 回测夏普的60%，资金翻倍
  - 直到达到目标仓位或流动性瓶颈
```

### 7.2 实盘监控指标

```
每日检查：
  - 实际滑点 vs 模型预设滑点
  - 实际成交率（maker单的fill rate）
  - 各因子IC值（是否在衰减）
  
每周检查：
  - 策略间相关性变化
  - 各币种流动性变化
  - 收益归因（多少来自alpha，多少来自beta暴露）

每月检查：
  - Walk-Forward重训练，更新因子权重
  - 淘汰IC持续为负的因子
  - 评估新币种的可交易性
```

---

## 八、资金分配总览

| 策略 | 资金占比 | 预期年化 | 预期最大回撤 | 预期夏普 |
|------|---------|---------|-------------|---------|
| Order Flow动量 | 35% | 40-80% | 8-12% | 2.5-4.0 |
| 均值回归 | 20% | 20-40% | 5-8% | 2.0-3.0 |
| Funding Rate套利 | 25% | 15-30% | 1-3% | 4.0-8.0 |
| 现金储备 | 20% | 0% | 0% | - |
| **组合** | **100%** | **25-45%** | **5-10%** | **2.5-4.0** |

> 注：以上预期基于理想执行，实盘通常会有20-40%的衰减。

---

## 附录：关键参数速查表

| 参数 | 推荐值 | 调优范围 |
|------|--------|---------|
| Dollar Bar大小（BTC） | 500K USD | 200K - 1M |
| OFI_fast窗口 | 20 bars | 10 - 50 |
| OFI_mid窗口 | 100 bars | 50 - 200 |
| OFI_slow窗口 | 500 bars | 300 - 800 |
| SmartFlow窗口 | 50 / 200 bars | 30-100 / 100-500 |
| 大单阈值倍数 | 5x均值 | 3x - 8x |
| VPIN窗口 | 50 bars | 30 - 100 |
| Kyle_Lambda窗口 | 100 bars | 50 - 200 |
| MR fast/slow | 20 / 200 bars | 10-50 / 100-500 |
| Sweep检测窗口 | 100ms | 50 - 200ms |
| Sweep最少笔数 | 5笔 | 3 - 8笔 |
| 信号开仓阈值 | ±1.5 σ | ±1.0 - ±2.0 |
| 信号平仓阈值 | ±0.5 σ | ±0.3 - ±0.8 |
| 固定止盈 | 0.3% | 0.2% - 0.5% |
| 硬止损 | 0.15% | 0.1% - 0.25% |
| 时间止损 | 200 bars | 100 - 500 bars |
| 单笔风险 | 0.5% equity | 0.3% - 1.0% |
| 单币最大仓位 | 10% equity | 5% - 15% |
| 总毛敞口上限 | 60% equity | 40% - 80% |
| Walk-Forward训练窗口 | 6个月 | 3 - 12个月 |
| Walk-Forward测试窗口 | 1个月 | 1 - 3个月 |
| 日亏损熔断（单策略） | 1% equity | 0.5% - 2% |
| 日亏损熔断（组合） | 2% equity | 1% - 3% |
| 月回撤减仓触发 | 5% | 3% - 8% |
